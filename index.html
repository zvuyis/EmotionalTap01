<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Emotion Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { 
            font-family: -apple-system, sans-serif; 
            background: #000; 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            justify-content: flex-start;
            overflow: hidden;
        }
        
        /* תיבת הטקסט במרכז */
        textarea { 
            width: 100%; 
            height: 50vh; 
            background: transparent; 
            border: none; 
            color: white; 
            padding: 20px; 
            font-size: 20px; 
            outline: none; 
            box-sizing: border-box;
            resize: none;
        }

        /* הנקודה מעל המקלדת */
        #emotionDot { 
            position: fixed;
            bottom: 300px; /* מיקום משוער מעל המקלדת באייפון */
            left: 50%;
            transform: translateX(-50%);
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            background: #444; 
            transition: all 0.2s ease;
            z-index: 100;
        }

        /* הסתרת המצלמה */
        video { position: fixed; opacity: 0; pointer-events: none; }

        #loader {
            position: fixed; inset: 0; background: black;
            display: flex; align-items: center; justify-content: center; z-index: 200;
            font-size: 14px; color: #888;
        }
    </style>
</head>
<body>

<div id="loader">טוען מערכת...</div>
<video id="video" autoplay muted playsinline></video>
<textarea id="textInput" placeholder="תתחיל להקליד..."></textarea>
<div id="emotionDot"></div>

<script>
    const video = document.getElementById('video');
    const dot = document.getElementById('emotionDot');
    const input = document.getElementById('textInput');
    const loader = document.getElementById('loader');

    let lastKeyTime = Date.now();
    let currentExpression = "neutral";

    async function setup() {
        try {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            
            loader.style.display = 'none';
            input.focus();
            detect();
        } catch (e) {
            loader.innerText = "שגיאה בגישה למצלמה";
        }
    }

    async function detect() {
        setInterval(async () => {
            const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            if (result) {
                const ex = result.expressions;
                // חיזוק זיהוי כעס - אם כעס מעל 0.1 זה כבר נחשב
                if (ex.angry > 0.1) currentExpression = "angry";
                else if (ex.surprised > 0.2) currentExpression = "surprised";
                else if (ex.sad > 0.2) currentExpression = "sad";
                else if (ex.happy > 0.3) currentExpression = "happy";
                else currentExpression = "neutral";
                
                updateUI();
            }
        }, 200);
    }

    input.addEventListener('input', () => {
        const now = Date.now();
        const speed = now - lastKeyTime;
        lastKeyTime = now;

        // אם ההקלדה מהירה מאוד (עצבים)
        if (speed < 90) updateUI(true); 
        else updateUI();
    });

    function updateUI(isFast = false) {
        let color = "#4ade80"; // ירוק

        if (currentExpression === "angry" || isFast) {
            color = "#ff4d4d"; // אדום (כועס)
        } else if (currentExpression === "surprised") {
            color = "#facc15"; // צהוב
        } else if (currentExpression === "sad") {
            color = "#a855f7"; // סגול
        } else if (currentExpression === "happy") {
            color = "#10b981"; // ירוק בהיר
        }

        dot.style.background = color;
        dot.style.boxShadow = `0 0 20px ${color}`;
    }

    setup();
</script>

</body>
</html>
