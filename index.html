<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Emotion Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { 
            font-family: -apple-system, sans-serif; 
            background: #000; 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            overflow: hidden;
        }
        
        /* תיבת הטקסט - תופסת את רוב המסך */
        textarea { 
            width: 100%; 
            height: 40vh; 
            background: #111; 
            border: none; 
            color: white; 
            padding: 20px; 
            font-size: 20px; 
            outline: none; 
            box-sizing: border-box;
            resize: none;
            margin-top: 5vh;
        }

        /* הנקודה - ממוקמת באמצע הגובה כדי שלא תוסתר */
        #emotionDot { 
            position: fixed;
            top: 50vh; /* ממוקם ב-50% מגובה המסך */
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: #444; 
            transition: all 0.2s ease;
            z-index: 9999;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        /* הסתרת המצלמה */
        video { position: fixed; opacity: 0; pointer-events: none; width: 1px; height: 1px; }

        #loader {
            position: fixed; inset: 0; background: black;
            display: flex; align-items: center; justify-content: center; z-index: 10000;
            font-size: 16px; color: #fff;
        }
    </style>
</head>
<body>

<div id="loader">טוען מערכת (נא לאשר מצלמה)...</div>
<video id="video" autoplay muted playsinline></video>
<textarea id="textInput" placeholder="הקלידו כאן..."></textarea>
<div id="emotionDot"></div>

<script>
    const video = document.getElementById('video');
    const dot = document.getElementById('emotionDot');
    const input = document.getElementById('textInput');
    const loader = document.getElementById('loader');

    let lastKeyTime = Date.now();
    let currentExpression = "neutral";

    async function setup() {
        try {
            // טעינת המודלים משרת ה-Models הרשמי
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            
            loader.style.display = 'none';
            input.focus();
            detect();
        } catch (e) {
            loader.innerText = "שגיאה: וודא שאישרת מצלמה ב-HTTPS";
            console.error(e);
        }
    }

    async function detect() {
        setInterval(async () => {
            if (video.paused || video.ended) return;
            const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            if (result) {
                const ex = result.expressions;
                // סף רגישות נמוך מאוד לזיהוי כעס
                if (ex.angry > 0.05) currentExpression = "angry"; 
                else if (ex.surprised > 0.1) currentExpression = "surprised";
                else if (ex.sad > 0.1) currentExpression = "sad";
                else if (ex.happy > 0.2) currentExpression = "happy";
                else currentExpression = "neutral";
                
                updateUI();
            }
        }, 200);
    }

    input.addEventListener('input', () => {
        const now = Date.now();
        const speed = now - lastKeyTime;
        lastKeyTime = now;

        if (speed < 100) updateUI(true); 
        else updateUI();
    });

    function updateUI(isFast = false) {
        let color = "#4ade80"; // ירוק כברירת מחדל

        if (currentExpression === "angry" || isFast) {
            color = "#ff4d4d"; // אדום
        } else if (currentExpression === "surprised") {
            color = "#facc15"; // צהוב
        } else if (currentExpression === "sad") {
            color = "#a855f7"; // סגול
        } else if (currentExpression === "happy") {
            color = "#10b981"; // ירוק בהיר
        }

        dot.style.background = color;
        dot.style.boxShadow = `0 0 30px ${color}`;
    }

    setup();
</script>

</body>
</html>
