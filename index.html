<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מגן רגשי v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --bg: #0f172a; --safe: #4ade80; --danger: #ef4444; --warn: #facc15; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; }
        
        #emotionDot { 
            position: fixed; top: 15%; width: 45px; height: 45px; border-radius: 50%; 
            background: var(--safe); transition: 0.4s; z-index: 1000;
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        .container { width: 90%; max-width: 450px; margin-top: 35%; background: #1e293b; padding: 25px; border-radius: 25px; }
        
        textarea { 
            width: 100%; height: 140px; background: #334155; border: 2px solid #475569; 
            border-radius: 15px; color: white; padding: 15px; font-size: 18px; outline: none; box-sizing: border-box; resize: none;
        }

        #statusText { font-size: 1.1rem; margin-bottom: 10px; font-weight: 600; }
        #lockOverlay { display: none; color: var(--danger); font-size: 0.9rem; margin-top: 10px; font-weight: bold; }
        video { position: fixed; opacity: 0; pointer-events: none; width: 1px; height: 1px; }
        #loader { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="loader">טוען הגנה חכמה...</div>
<video id="video" autoplay muted playsinline></video>
<div id="emotionDot"></div>

<div class="container">
    <div id="statusText">מערכת מוכנה</div>
    <textarea id="textInput" placeholder="כתבו כאן..."></textarea>
    <div id="lockOverlay">זוהה שיח פוגעני. קחו רגע למחשבה... (5 שנ')</div>
</div>

<script>
    const video = document.getElementById('video');
    const dot = document.getElementById('emotionDot');
    const input = document.getElementById('textInput');
    const status = document.getElementById('statusText');
    const loader = document.getElementById('loader');
    const lockOverlay = document.getElementById('lockOverlay');

    const redPatterns = [
        { words: ["שונא", "את"], label: "שנאה ממוקדת" },
        { words: ["אל", "תענו"], label: "ניסיון השתקה" },
        { words: ["אפס", "אתה"], label: "פגיעה אישית" }
    ];

    const safeContext = ["כי", "אבל", "אוהב", "חחח"]; // מילים שמנטרלות חשד לאלימות

    let isLocked = false;

    async function init() {
        try {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            loader.style.display = 'none';
            analyze();
        } catch (e) { loader.innerText = "נא לאשר מצלמה"; }
    }

    function analyze() {
        setInterval(async () => {
            if (isLocked) return;
            const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            const text = input.value;
            
            // לוגיקה חכמה: בודק אם יש צירוף אדום, וגם שאין מילת "הגנה"
            const hasPattern = redPatterns.find(p => p.words.every(w => text.includes(w)));
            const hasSafeWord = safeContext.some(w => text.includes(w));

            if (hasPattern && !hasSafeWord) {
                triggerLock(hasPattern.label);
            } else if (result) {
                const ex = result.expressions;
                const topEx = Object.keys(ex).reduce((a, b) => ex[a] > ex[b] ? a : b);
                updateUI(topEx);
            }
        }, 400);
    }

    function updateUI(emotion = "neutral") {
        if (isLocked) return;
        let color = "var(--safe)";
        let txt = "שיח תקין";

        if (emotion === "angry") {
            color = "var(--warn)";
            txt = "שימו לב לטון ההקשה...";
        }
        
        dot.style.background = color;
        status.innerText = txt;
        status.style.color = color;
    }

    function triggerLock(reason) {
        if (isLocked) return;
        isLocked = true;
        dot.style.background = "var(--danger)";
        status.innerText = "עצור: " + reason;
        status.style.color = "var(--danger)";
        
        input.disabled = true;
        lockOverlay.style.display = "block";

        setTimeout(() => {
            isLocked = false;
            input.disabled = false;
            lockOverlay.style.display = "none";
            // שיפור: לא מוחקים הכל, רק נותנים פוקוס חזרה
            updateUI();
            input.focus();
        }, 5000);
    }

    init();
</script>
</body>
</html>
